<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layouts/layout_main}">
<head>
<meta charset="utf-8">

	<script type="text/javascript">
	
		$(document).ready(function(){ //페이지가 로딩이 완료 되었을 때 자동으로 호출된다
	    	
			//onClick 이벤트를 호출하기 위해 함수 호출
			//수강신청 버튼 클릭
		    $('#classOff').on('click', function(event) {
		    	var url = "/applyList";
		        var paramData = {
		            classId : $("#classId").val()
		        };

		        var param = JSON.stringify(paramData);
		        
		        $.ajax({
		            url      : url,
		            type     : "POST",
		            contentType : "application/json",
		            data     : param,
//		             beforeSend : function(xhr){
		                /* 데이터를 전송하기 전에 헤더에 csrf값을 설정 */
//		                 xhr.setRequestHeader(header, token);
//		                },
		            dataType : "json",
		            cache   : false,
		            success  : function(result, status){
		            	var applyId = result;
		            	
		            	if (applyId > 0) {
		                	alert("수강신청이 완료되었습니다.");
		            		$("#classOff").css("display","none"); //표시하지않는다
		                    $("#classOn").css("display",""); //표시한다
		            	} else if (applyId == -777) {
		                	alert("이미 수강신청을 하였습니다.");
		            		$("#classOff").css("display","none"); //표시하지않는다
		                    $("#classOn").css("display",""); //표시한다
		            	} else if (applyId == -7) {
		            		alert("강의신청을 하기 위해서는 로그인이 되어있어야 합니다.");
		            		$("#classOff").css("display",""); //표시한다
		            		$("#classOn").css("display","none"); //표시하지않는다
		            	} else {
		            		alert("수강신청에 실패하였습니다.");
		                    $("#classOff").css("display",""); //표시한다
		            		$("#classOn").css("display","none"); //표시하지않는다
		            	}
					},
		            error : function(jqXHR, status, error) {
		                $("#classOff").css("display",""); //표시한다
		            	$("#classOn").css("display","none"); //표시하지않는다
		            	
		                if(jqXHR.status == '401') {
		                    alert('로그인 후 이용해주세요');
		                    location.href='/users/signIn';
		                } else{
		                    alert(jqXHR.responseText);
		                }
		            }
		        });
		    });
		        	        
		        //리뷰삭제
			    
	 			$('.btn-review-del').on('click', function(e) {
	 				var btnDelIndex = $('.btn-review-del').index(this); //클릭한 삭제 버튼의 index 확인. start index by 0
	 				var reviewId = $("input[name=reviewId]:eq(" + btnDelIndex + ")").val(); //화면에 표시된 review id 값 가져오기
	 				var classId = $("#classId").val();
	 				
	 				$(location).attr('href', '/mainForm/review/delete/' + reviewId + '/' + classId);
				});
			
			//별점 클릭
		    $('.rate_radio').on('click', function(e) {
 				var chkboxIndex = $('.rate_radio').index(this); //클릭한 수정 버튼의 index 확인. start index by 0
 				var rate = $("input:checkbox[name=rating]:eq(" + chkboxIndex + ")").val(); //체크한 별점에 해당하는 점수 가져오기
 				
 				var maxCnt = 5;
 				
 				for (var idx=0; idx<maxCnt; idx++) {
 					//현재 클릭한 별점과 같거나 작은 경우
 					//별점은 1 부터 시작한다
 					//index 는 0 부터 시작한다
 					//예를 들어 벌점이 3 이면, index 가 0, 1, 2 가 체크 되어야 한다
 					if (idx < rate) {
 						$("input:checkbox[name=rating]:eq(" + idx + ")").prop("checked", true); //별점 체크
 					} else {
 						$("input:checkbox[name=rating]:eq(" + idx + ")").prop("checked", false); //별점 해제
 					}
 				}
 				
 				$('#rate').val(rate); //서버에 넘기기위한 별점 점수 설정
			});
		    
			//등록 버튼 클릭
		    $('#save').on('click', function(event) {
		    	var rate = $('#rate').val(); //서버에 넘기기위한 별점 점수
		    	
		    	//별점 확인
				if(rate == 0){
					alert("별점을 선택해 주세요!");
					return false;
				}
		    	
				var review = $('.review_textarea').val();
				var reviewLen = review.length; //리뷰 코멘트 입력 길이 
		    	
				//리뷰 5자 미만이면 메시지 표시
				if(reviewLen < 5 || reviewLen > 400) {
					alert("리뷰는 5자 이상 400자 이하로 입력해 주세요!");
					return false;
				}
				
				//리뷰 등록
				var url = "/mainForm/detail";
		        var paramData = {
		        	classId : $("#classId").val(),
		        	starPoint : $("#rate").val(),
		        	description : $('.review_textarea').val()
		        };

		        var param = JSON.stringify(paramData);
		        
		        $.ajax({
		            url      : url,
		            type     : "POST",
		            contentType : "application/json",
		            data     : param,
//		             beforeSend : function(xhr){
		                /* 데이터를 전송하기 전에 헤더에 csrf값을 설정 */
//		                 xhr.setRequestHeader(header, token);
//		                },
		            dataType : "json",
		            cache   : false,
		            success  : function(result, status){
		            	var reviewId = result;
		            	
		            	if (reviewId > 0) {
		                	alert("리뷰 등록이 완료되었습니다.");
		            		$("#save").css("display","none"); //표시하지않는다
		            		
		            		var classId = $("#classId").val();
			 				
			 				$(location).attr('href', '/mainForm/detail/' + classId);
		            	} else if (reviewId == -777) {
		                	alert("이미 리뷰 등록을 하였습니다.");
		                	$("#save").css("display","none"); //표시하지않는다

		            		var classId = $("#classId").val();
			 				
			 				$(location).attr('href', '/mainForm/detail/' + classId);
		            	} else if (reviewId == -7) {
		            		alert("리뷰 등록을 하기 위해서는 로그인이 되어있어야 합니다.");
		            		$("#save").css("display",""); //표시한다
		            	} else if (reviewId == -9) {
		            		alert("리뷰 등록을 하기 위해서는 수강신청이 되어있어야 합니다.");
		            		$("#save").css("display",""); //표시한다
		            	} else {
		            		alert("리뷰 등록에 실패하였습니다.");
		                    $("#save").css("display",""); //표시한다
		            	}
					},
		            error : function(jqXHR, status, error){
		            	 $("#save").css("display",""); //표시한다
		            	
		                if(jqXHR.status == '401') {
		                    alert('로그인 후 이용해주세요');
		                    location.href='/users/signIn';
		                } else {
		                    alert(jqXHR.responseText);
		                }
		            }
		        });
		    });
		    
		 	//onKeyup 이벤트를 호출하기 위해 함수 호출
		 	//리뷰 입력
		    $('.review_textarea').on('keyup', function(event) {
				var review = $(this).val();
				var reviewLen = review.length; //리뷰 코멘트 입력 길이 
				var limitLen = 400; //제한길이
				
				//제한길이보다 입력한 내용이 큰 경우
				if(reviewLen > limitLen) {
					$(this).val( review.substr(0,limitLen) ); //제한길이에 맞춰서 입력내용을 자른다
				}
				
				$('#rate_count').text(review.length + "/" + limitLen); //현재 입력한 길이 표시
		    });
		});
	</script>

<style>
img{
	width: 300px;
	height: 500px;
}

/* 레이아웃 외곽 너비 400px 제한*/
.wrap{
    max-width: 480px;
    margin: 0 auto; /* 화면 가운데로 */
    background-color: #fff;
    height: 100%;
    padding: 20px;
    box-sizing: border-box;

}
.reviewform textarea{
    width: 100%;
    padding: 10px;
    box-sizing: border-box;
}
.rating .rate_radio {
    position: relative;
    display: inline-block;
    z-index: 20;
    opacity: 0.001;
    width: 60px;
    height: 60px;
    background-color: #fff;
    cursor: pointer;
    vertical-align: top;
    display: none;
}
.rating .rate_radio + label {
    position: relative;
    display: inline-block;
    margin-left: -4px;
    z-index: 10;
    width: 60px;
    height: 60px;
    background-image: url('/img/icons/star.png');
    background-repeat: no-repeat;
    background-size: 60px 60px;
    cursor: pointer;
    background-color: #f0f0f0;
}
.rating .rate_radio:checked + label {
    background-color: #0D6EFD;
}

.warning_msg {
    display: none;
    position: relative;
    text-align: center;
    background: #ffffff;
    line-height: 26px;
    width: 100%;
    color: red;
    padding: 10px;
    box-sizing: border-box;
    border: 1px solid #e0e0e0;
}

.rating2 {
	width: 130px;
    height: 30px;
}

.rating2 .icon_star {
    position: relative;
    display: inline-block;
    z-index: 20;
    opacity: 0.001;
    width: 30px;
    height: 30px;
    cursor: pointer;
    vertical-align: top;
    display: none;
}
.rating2 .icon_star + label {
    position: relative;
    display: inline-block;
    margin-left: -4px;
    z-index: 10;
    width: 20px;
    height: 20px;
    background-image: url('/img/icons/star.png');
    background-repeat: no-repeat;
    background-size: 60px 60px;
    cursor: pointer;
    background-color: #0D6EFD;
}

.bd-placeholder-img {
  font-size: 1.125rem;
  text-anchor: middle;
  -webkit-user-select: none;
  -moz-user-select: none;
  user-select: none;
}

@media (min-width: 768px) {
  .bd-placeholder-img-lg {
    font-size: 3.5rem;
  }
}

</style>

<title>courses</title>
</head>
<body>

	<div layout:fragment="content">
	   <!-- Header Start -->
	 	<div style="display: none;">
			<input type="hidden" id="delIndex" name="delIndex" value="-1" />
		</div>
		    <div class="container-fluid bg-primary py-5 mb-5 page-header">
		        <div class="container py-5">
		            <div class="row justify-content-center">
		                <div class="col-lg-10 text-center">
		                    <h1 class="display-3 text-white animated slideInDown">Courses</h1>
		                    <nav aria-label="breadcrumb">
		                        <ol class="breadcrumb justify-content-center">
		                            <li class="breadcrumb-item"><a class="text-white" href="/">Home</a></li>
		                            <li class="breadcrumb-item"><a class="text-white" href="#">Class</a></li>
		                            <li class="breadcrumb-item text-white active" aria-current="page">Class</li>
		                        </ol>
		                    </nav>
		                </div>
		            </div>
		        </div>
		    </div>
	    <!-- Header End -->
                
        <input type="hidden" id="classId" th:value="${adminClassDto.id}">
				
				<div class="row g-5 justify-content-center">
				<!-- 제목 -->
				<div class="col-md-6">
					<h3 class="pb-4 mb-4 fst-italic border-bottom">
						From the Firehose
					</h3>
				</div>
				
					<!-- 오른쪽 신청버큰 고정 -->
					<div class="col-md-2">
					<div class="position-sticky" style="top: 2rem;">
					<div class="p-4 mb-3 bg-light rounded">
						<h4 class="fst-italic">무료신청</h4>
						<div class="p-4">
		                          <input type="button" class="btn btn-primary btn-lg" id="classOff" th:style="${isApplyListNew == 'Y' ? 'display: block;' : 'display: none;'}" value="수강신청">
		                          <input type="button" class="btn btn-primary btn-lg" id="classOn" th:style="${isApplyListNew != 'Y' ? 'display: block;' : 'display: none;'}" value="신청완료">
		                </div>
						<p class="mb-0"></p>
					</div>
					</div>
					</div>
				</div>
					<!-- 오른쪽 신청버큰 고정 -->				

				<!-- 제목 -->
				
					
					<!-- 강의 이미지 -->
					    <div class="row featurette justify-content-center">
					      <div class="col-md-6 order-md-2">
					        <h2 class="featurette-heading fw-normal lh-1"> 강의 <span class="text-muted"> 강의 </span></h2>
					        <p class="lead">테스트입니다</p>
					      </div>
					      <div class="col-md-2 order-md-1">
					      	<img class="bd-placeholder-img bd-placeholder-img-lg featurette-image img-fluid mx-auto" width="500" height="500" preserveAspectRatio="xMidYMid slice" focusable="false" th:src="${classDetail.imgUrl}"  th:alt="이미지">
					      </div>
					    </div>
					<!-- 강의 이미지 -->			
				

		   			<!-- 커리큘럼 메뉴바 -->
		              <div class="course__tab-2 mb-45 col-md-6 justify-content-center">
		                 <ul class="nav nav-tabs" id="courseTab" role="tablist">
		                    <li class="nav-item" role="presentation">
		                      <button class="nav-link active" id="description-tab" data-bs-toggle="tab" data-bs-target="#description" type="button" role="tab" aria-controls="description" aria-selected="true"> <i class="icon_ribbon_alt"></i> <span>Discription</span> </button>
		                    </li>
		                    <li class="nav-item" role="presentation">
		                      <button class="nav-link" id="review-tab" data-bs-toggle="tab" data-bs-target="#review" type="button" role="tab" aria-controls="review" aria-selected="false"> <i class="icon_star_alt"></i> <span>Reviews</span> </button>
		                    </li>
		                  </ul>
		              </div>
		              <!-- 커리큘럼 메뉴바 -->
              		
              		<!-- 커리큘럼 시작 -->
	                <div class="course__tab-content mb-95">
	              		<div class="tab-content" id="courseTabContent">
	                		<div class="tab-pane fade active show" id="description" role="tabpanel" aria-labelledby="description-tab">
	                    		<div class="course__description">
	                       			<h3>Course Overview</h3>
	                       			<p>Only a quid me old mucker squiffy tomfoolery grub cheers ruddy cor blimey guvnor in my flat, up the duff Eaton car boot up the kyver pardon you A bit of how's your father David skive off sloshed, don't get shirty with me chip shop vagabond crikey bugger Queen's English chap. Matie boy nancy boy bite your arm off up the kyver old no biggie fantastic boot, David have it show off show off pick your nose and blow off lost the plot porkies bits and bobs only a quid bugger all mate, absolutely bladdered bamboozled it's your round don't get shirty with me down the pub well. Give us a bell bits and bobs Charles he lost his bottle super my lady cras starkers bite your arm off Queen's English, pardon me horse play Elizabeth a blinding shot chinwag knees up do one David, blag cup of tea Eaton so I said bleeding haggle James Bond cup of char. Gosh William ummm I'm telling crikey burke I don't want no agro A bit of how's your father bugger all mate off his nut that, what a plonker cuppa owt to do with me nancy boy show off show off pick your nose and blow off spiffing good time lavatory me old mucker, chimney pot what a load of rubbish boot squiffy lost the plot brolly wellies excuse my french.</p>
	                 			</div>
	                 		</div>
	                 	</div>
	                 </div>
	                 <!-- 커리큘럼 끝 -->

	                 <!-- 리뷰 시작 -->
	                 <div class="tab-pane fade" id="review" role="tabpanel" aria-labelledby="review-tab">
	                 <div class="wrap">
	                    
	                 <!-- 코멘트 -->
	                 <form id="delFrm" action="/mainForm/detail/{reviewId}">
	                 	<input type="hidden" name="_method" value="delete"/>
	                 <div class="course__comment mb-75">
	                    <h3>[[${#lists.size(classReviewList)}]] Comments</h3>
	
		                 <th:block th:each="class_review, stat: ${classReviewList}">
	                    <ul>
	                       <li>
	                          <div class="course__comment-box ">
	                             <div class="course__comment-content">
	                                <div class="course__comment-wrapper ml-70 fix">
	                                   <div class="course__comment-info float-start">
	                                      <h4>[[${class_review.userName}]]</h4>
	                                      <span>[[${class_review.regDate}]]</span>
	                                   </div>
	                                   <div class="course__comment-rating float-start float-sm-end">
		                                <small class="fa fa-star text-primary"></small>
		                                <small class="fa fa-star text-primary"></small>
		                                <small class="fa fa-star text-primary"></small>
		                                <small class="fa fa-star text-primary"></small>
		                                <small class="fa fa-star text-primary"></small>
						            	<label>([[${class_review.starPoint}]])</label>
	                                   </div>
	                                </div>
	                                <div class="course__comment-text">
	                                   <p>[[${class_review.description}]]</p>
	                             	</div>
	                          	</div>
	                          </div>
	                       </li>
		               		<div class="cmd">
		               			<input type="hidden" name="reviewId" th:value="${class_review.id}" />
								<input type="button" class="btn btn-primary btn-sm btn-review-del" value="삭제" />
				        	</div>
	                    </ul>
	                    </th:block>
	                 </div> 
	            	</form>
	            	<!-- 코멘트 -->
	            	
	                 	<!-- 후기 작성 -->
					    <h1 style="font-size: 30px;">후기</h1>
					    <form name="reviewform" class="reviewform" method="post" action="/save">
					        <input type="hidden" name="rate" id="rate" value="0"/>
					        <p class="title_star">별점과 리뷰를 남겨주세요.</p>
					 
					        <div class="review_rating">
					            <div class="warning_msg">별점을 선택해 주세요.</div>
					            <div class="rating">
					                <!-- 해당 별점을 클릭하면 해당 별과 그 왼쪽의 모든 별의 체크박스에 checked 적용 -->
					                <input type="checkbox" name="rating" id="rating1" value="1" class="rate_radio" title="1점">
					                <label for="rating1"></label>
					                <input type="checkbox" name="rating" id="rating2" value="2" class="rate_radio" title="2점">
					                <label for="rating2"></label>
					                <input type="checkbox" name="rating" id="rating3" value="3" class="rate_radio" title="3점" >
					                <label for="rating3"></label>
					                <input type="checkbox" name="rating" id="rating4" value="4" class="rate_radio" title="4점">
					                <label for="rating4"></label>
					                <input type="checkbox" name="rating" id="rating5" value="5" class="rate_radio" title="5점">
					                <label for="rating5"></label>
					            </div>
					        </div>
					        <div class="review_contents">
					        	<label id="rate_count">0/400</label>
					            <textarea rows="10" class="review_textarea" name="description" placeholder="5자 이상 400자 이하로 작성해 주세요."></textarea>
					        </div>   
					        <div class="cmd">
					        	<input type="button" class="btn btn-primary btn-lg" id="save" value="등록">
					        </div>
					    </form>
					    <!-- 후기 작성 -->					    
					</div>		
				</div>
				<!-- 리뷰 끝! -->

	</div>
</body>
</html>